
Generate [Vagrant Boxes](http://vagrantup.com) in [VirtualBox](http://virtualbox.org) using [Packer](http://packer.io)

There's also a [CentOS Box](http://vagrantup.com) in HyperV 


# List of Boxes (images) you can generate

Boxes are generated by json files. Below is a description.
 
## Ubuntu Boxes

All Ubuntu run on top of VirtualBox

* Select ubuntu-desktop for building Ubuntu Desktop 20.04 64-bit

* Select ubuntu-desktop for building Ubuntu Desktop 19.10 64-bit

* Select ubuntu-server for building Ubuntu Server 20.04 64-bit headless

* Select ubuntu-server for building Ubuntu Server 19.10 64-bit headless

**Note about ubuntu 20.04**
20.04 no longer support [preseed.cfg](https://askubuntu.com/questions/1233454/how-to-preseed-ubuntu-20-04-desktop) so to use it we need to refer to ubuntu 20.04 "legacy images" for now.

**Older versions of Ubuntu** 
You can use the ubuntu19 jsons to build any ubuntu desktop or server with the version of your choosing. Edit the variables inside the json according to what you want. If not, the version indicated will be installed.


## CentOs Boxes

* CentOS 8 64 bit Server on VirtualBox

* CentOS 7 64-bit on HyperV.

The CentOs Hyper V builds a CentOS on top of the Windows virtualization software HyperV in Windows 10 Ultimate.

# How generate a box
 
 
Install [Packer](www.packer.io), [Vagrant](http://vagrantup.com) and [VirtualBox](http://virtualbox.org).

You can edit any variables in the json variable with the linux of your choosing

Run: ```packer build \<json\>```

Afterwards if you want you can do:

```vagrant box add ./build/name-of-the-box --name your-nickname```

Ex:
vagrant box add ./build/ubuntu-19.04-desktop-amd64-virtualbox.box --name my-ubuntu

# Using the Box
Go to main programming folder

Run ```vagrant init <your box name>```

This will generate a Vagrantfile based on the Vagranfile template.

# Box configuration details

## VM resources & Vagrantfile

The boxes resources will be configured by Vagrantfile templates for use but you can overwrite it using your own Vagrantfile. The only thing that the json does is to set the disk size.

## OS configuration files

The unattended configuration files that will setup the box are in the http folder. They automate the OS installation screens

## Runing ansible to configure OS

*PS: Ansible is currently not working for Ubuntu Focal*
Ansible has not been released for Ubuntu Focal as per https://github.com/ansible/ansible/issues/69414


You have two options to configure your OS with ansible: 

1. You use Packer to configure your Basic Vagrant Box and then after you can run Vagrant to run Ansible
2. You use Packer to configure everything and packer will run ansible. The resulting Vagrant box will contain everything. 

### Running ansible from Vagrant
Packer creates a very basic Vagranfile. When you do a **vagrant init** you will create your own Vagrant file and you can define some additional machine specific configuration.

After you create your ISO, you can run Ansible through vagrant by adding the following to your Vagrantfile. More options can be found in https://www.vagrantup.com/docs/provisioning/ansible.html


```
Vagrant.configure("2") do |config|
  config.vm.provision "ansible_local" do |ansible|
    ansible.playbook = "myansible/playbook.yml"
    ansible.verbose = true
  end
end
```

### (WIP) Running ansible from Packer

TODO: This is WIP


# Vagrantfile tips

Packer creates a very basic Vagranfile. When you do a **vagrant init** you will create your own Vagrant file and you can define some additional machine specific configuration.

## Defining names and hostnames in Vagrant
This not related to packer necessarily but if you want to name your VM your way instead of using Vagrant defaults you edit the Vagrant and even overwrite some configs.


```
Vagrant.configure("2") do |config|
 # Hostname
  config.vm.hostname = "myubuntuvm"
  # Replace default in vagrant
  config.vm.define "myubuntuvm"
  # Name in GUI
  config.vm.provider :virtualbox do |vb|
    vb.name = "myubuntuvm"
  end
end
```

## Define multiple machines in one file

Once you define multi machines in one vagrantfile you can target a machine using vagrant

```
vagrant up myubuntuvn
```

Here is a snipet

```
Vagrant.configure("2") do |config|

  config.vm.define "myubuntuvm" do |myubuntuvm|

    myubuntuvm.vm.box = "ubuntu-20.04-desktop-amd64"
    myubuntuvm.vm.hostname = "myubuntuvm"
    myubuntuvm.vm.provider :virtualbox do |virtualbox|
      virtualbox.name = "myubuntuvm"
    end
  end

  config.vm.define "mydevvm" do |mydevvm|

    mydevvm.vm.box = "ubuntu-19.10-desktop-amd64"
    mydevvm.vm.hostname = "mydevvm"
    mydevvm.vm.provider :virtualbox do |virtualbox|
      virtualbox.name = "mydevvm"
    end
  end
end
```


# Known Errors with Packer
 

**Curl - Port is too large**

To solve this rename your boot_command to a smaller string

 

**When Packer is typing the boot_command it duplicates or remove characters**

This is a known issue due to host CPU load. There’s no fix. You need just run
again and again or correct the command manually:
https://github.com/hashicorp/packer/issues/1796
